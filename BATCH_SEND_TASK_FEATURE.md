# 自动批量发送邮件任务功能

## 功能概述

自动批量发送邮件任务功能允许用户创建和管理批量邮件发送任务，支持多个收件人列表的按序发送、发送间隔控制、邮件跟踪等功能。

## 主要特性

### 1. 任务管理
- **任务列表**：查看所有批量发送任务及其状态
- **任务创建**：创建新的批量发送任务
- **任务控制**：开始、暂停、恢复、停止任务
- **任务删除**：删除不需要的任务

### 2. 收件人列表管理
- **多选支持**：可选择多个收件人列表
- **发送顺序**：按列表顺序依次发送
- **间隔控制**：每个列表发送完成后等待指定时间再发送下一个
- **只读保护**：支持只读收件人列表（不可删除的列表）

### 3. 邮件配置
- **模板选择**：选择预定义的邮件模板
- **发件人设置**：配置发件人名称和邮箱地址
- **标签管理**：为邮件添加标识标签
- **跟踪功能**：启用邮件打开、点击等行为跟踪

### 4. 状态监控
- **实时状态**：pending（等待中）、running（运行中）、completed（已完成）、failed（失败）、paused（已暂停）
- **进度显示**：显示发送进度和成功率
- **统计信息**：任务总数、各状态任务数量统计

## 技术实现

### 1. 数据模型

#### BatchSendTaskModel
```dart
class BatchSendTaskModel {
  final String taskId;           // 任务ID
  final String taskName;         // 任务名称
  final String templateId;       // 模板ID
  final String templateName;     // 模板名称
  final List<ReceiverListConfig> receiverLists; // 收件人列表配置
  final String senderAddress;    // 发件人邮箱
  final String senderName;       // 发件人名称
  final String? tag;             // 发件标签
  final bool enableTracking;     // 是否启用跟踪
  final String status;           // 任务状态
  final DateTime createdAt;      // 创建时间
  final DateTime? startedAt;     // 开始时间
  final DateTime? completedAt;   // 完成时间
  final int totalEmails;         // 总邮件数
  final int sentEmails;          // 已发送邮件数
  final int failedEmails;        // 失败邮件数
}
```

#### ReceiverListConfig
```dart
class ReceiverListConfig {
  final String receiverId;       // 收件人列表ID
  final String receiverName;     // 收件人列表名称
  final int intervalMinutes;     // 发送间隔（分钟）
  final int emailCount;          // 邮件数量
}
```

### 2. Provider 架构

#### BatchSendTaskProvider
- **状态管理**：管理任务列表、加载状态、错误信息
- **任务操作**：添加、删除、更新任务状态
- **数据过滤**：按状态、关键词搜索任务
- **统计功能**：计算各状态任务数量

### 3. 用户界面

#### 任务列表页面 (BatchSendTaskListPage)
- **统计卡片**：显示各状态任务数量
- **搜索过滤**：按任务名称、模板名称、发件人搜索
- **状态筛选**：按任务状态筛选
- **任务卡片**：显示任务详细信息、进度、操作按钮

#### 任务创建页面 (BatchSendTaskCreatePage)
- **基本信息**：任务名称设置
- **模板选择**：下拉选择邮件模板
- **收件人列表**：多选收件人列表，设置发送间隔
- **发件人设置**：发件人名称、邮箱、标签
- **高级设置**：邮件跟踪开关

### 4. 服务集成

#### AliyunEdmService 扩展
```dart
// 批量发送任务相关方法
Future<List<BatchSendTaskModel>> getBatchSendTasks();
Future<bool> createBatchSendTask(BatchSendTaskModel task);
Future<bool> deleteBatchSendTask(String taskId);
Future<bool> updateBatchSendTaskStatus(String taskId, String status);
```

## 使用流程

### 1. 创建批量发送任务

1. **导航到批量发送任务页面**
   - 在侧边栏选择"发送邮件" → "批量发送任务"

2. **点击"新建任务"按钮**
   - 进入任务创建页面

3. **填写基本信息**
   - 输入任务名称（必填）

4. **选择邮件模板**
   - 从下拉列表选择预定义的邮件模板

5. **配置收件人列表**
   - 选择多个收件人列表
   - 为每个列表设置发送间隔时间
   - 查看发送顺序预览

6. **设置发件人信息**
   - 输入发件人名称和邮箱地址
   - 可选添加发件标签

7. **配置高级设置**
   - 选择是否启用邮件跟踪

8. **创建任务**
   - 点击"创建任务"按钮完成创建

### 2. 管理批量发送任务

1. **查看任务列表**
   - 在批量发送任务页面查看所有任务
   - 使用搜索和筛选功能快速找到目标任务

2. **监控任务状态**
   - 查看任务实时状态和发送进度
   - 监控成功率和失败数量

3. **控制任务执行**
   - **开始任务**：将等待中的任务设置为运行状态
   - **暂停任务**：暂停正在运行的任务
   - **恢复任务**：恢复已暂停的任务
   - **停止任务**：停止正在运行的任务

4. **删除任务**
   - 删除不需要的任务（不可恢复）

## 功能特点

### 1. 智能发送控制
- **按序发送**：严格按照收件人列表顺序发送
- **间隔控制**：每个列表发送完成后等待指定时间
- **错误处理**：发送失败时自动记录并继续下一个

### 2. 用户体验优化
- **实时反馈**：任务状态和进度实时更新
- **操作便捷**：一键开始、暂停、恢复、停止
- **信息完整**：显示详细的发送统计和进度信息

### 3. 数据安全
- **只读保护**：支持只读收件人列表，防止误删
- **状态持久化**：任务状态持久化保存
- **操作记录**：记录所有任务操作历史

### 4. 扩展性设计
- **模板系统**：支持多种邮件模板
- **配置灵活**：可自定义发送间隔、跟踪设置等
- **API集成**：预留阿里云API集成接口

## 测试覆盖

### 单元测试
- **数据模型测试**：测试 BatchSendTaskModel 和 ReceiverListConfig
- **数据转换测试**：测试 fromMap 和 toMap 方法
- **默认值测试**：测试各种默认值处理
- **复制方法测试**：测试 copyWith 方法

### 测试文件
- `test/batch_send_task_test.dart`：包含完整的单元测试

## 注意事项

1. **发送间隔设置**：建议根据邮件服务商的限制合理设置发送间隔
2. **收件人列表选择**：确保选择的收件人列表包含有效的邮箱地址
3. **任务状态管理**：注意任务状态的变化，避免重复操作
4. **数据备份**：重要任务建议定期备份配置信息
5. **API限制**：注意阿里云邮件推送服务的API调用限制

## 未来扩展

1. **定时发送**：支持设置任务开始时间
2. **条件发送**：基于收件人属性条件发送
3. **模板变量**：支持动态模板变量替换
4. **发送报告**：详细的发送统计和报告
5. **批量操作**：支持批量开始、暂停、删除任务
6. **邮件预览**：发送前预览邮件内容
7. **A/B测试**：支持邮件模板A/B测试 